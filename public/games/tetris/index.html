<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tetris â€” Vibe Coding Demo</title>
  <style>
    :root {
      --bg:     #070a10;
      --panel:  rgba(17,26,35,.78);
      --line:   rgba(90,140,180,.18);
      --text:   #e9eef5;
      --muted:  #9fb0c3;
      --accent: #7dd3fc;
      --danger: #fb7185;
      --glow:   #00d4ff;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      width: 100%; height: 100%;
      background: radial-gradient(1200px 800px at 20% 0%,
        #0e1b2b 0%, var(--bg) 55%, #05070c 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
    }

    /* â”€â”€ ì•± ì „ì²´ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .app {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100svh;
    }

    /* â”€â”€ ê²Œì„ ì˜ì—­: ë³´ë“œ + ì‚¬ì´ë“œë°” â”€â”€â”€â”€â”€â”€â”€ */
    .game-area {
      display: flex;
      align-items: flex-start;
      gap: 1.25rem;
    }

    /* â”€â”€ ë³´ë“œ í…Œë‘ë¦¬ (ê°œì„ : ë°ì€ ê¸€ë¡œìš°) â”€â”€ */
    #board {
      display: block;
      border: 2px solid var(--glow);
      box-shadow:
        0 0 16px rgba(0,212,255,.35),
        0 0 4px  rgba(0,212,255,.8);
      background: #080b12;
      flex-shrink: 0;
    }

    /* â”€â”€ ë°ìŠ¤í¬íƒ‘ ì‚¬ì´ë“œë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-width: 130px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 0.85rem 1.1rem;
    }
    .panel-label {
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.3rem;
    }
    .panel-value {
      font-size: 1.55rem;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: -0.02em;
      line-height: 1;
    }
    #next-canvas { display: block; margin-top: 0.5rem; }
    .hint { font-size: 0.7rem; color: var(--muted); line-height: 1.9; }
    .hint b { color: var(--text); font-weight: 600; }

    /* â”€â”€ ë®¤íŠ¸ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mute-btn {
      width: 100%;
      padding: 0.5rem;
      background: rgba(0,212,255,.07);
      border: 1.5px solid rgba(0,212,255,.35);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.03em;
      transition: background 0.1s;
      -webkit-tap-highlight-color: transparent;
    }
    .mute-btn:hover, .mute-btn:active { background: rgba(0,212,255,.18); }
    /* ëª¨ë°”ì¼ ì •ë³´ë°” ë®¤íŠ¸ ë²„íŠ¼ */
    .mi-mute {
      background: none;
      border: 1px solid rgba(0,212,255,.3);
      border-radius: 6px;
      color: var(--text);
      font-size: 1rem;
      width: 36px; height: 28px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* â”€â”€ ëª¨ë°”ì¼ ìƒë‹¨ ì •ë³´ë°” (ê¸°ë³¸ ìˆ¨ê¹€) â”€â”€â”€ */
    .mobile-info {
      display: none;
      width: 100%;
      align-items: center;
      justify-content: space-around;
      padding: 6px 8px;
      background: rgba(8,11,18,.9);
      border-bottom: 1px solid rgba(0,212,255,.2);
      flex-shrink: 0;
    }
    .mi-item { text-align: center; }
    .mi-label {
      display: block;
      font-size: 0.58rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .mi-val {
      display: block;
      font-size: 1rem;
      font-weight: 800;
      color: var(--accent);
      line-height: 1.2;
    }
    #m-next-canvas { display: block; }

    /* â”€â”€ í„°ì¹˜ ì»¨íŠ¸ë¡¤ (ê¸°ë³¸ ìˆ¨ê¹€, í”Œë¡œìš° í•˜ë‹¨ 160px) */
    .touch-pad {
      display: none;
      width: 100%;
      height: 160px;
      flex-shrink: 0;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 8px;
      padding: 10px 28px calc(10px + env(safe-area-inset-bottom, 0px));
      background: rgba(7,10,16,.92);
      border-top: 1px solid rgba(0,212,255,.2);
      justify-items: center;
      align-items: center;
    }
    .tc-btn {
      width:  68px;
      height: 64px;
      border: 1.5px solid rgba(0,212,255,.4);
      border-radius: 14px;
      background: rgba(0,212,255,.07);
      color: var(--text);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.08s;
    }
    .tc-btn:active { background: rgba(0,212,255,.25); }

    /* D-pad ë°°ì¹˜ */
    #btn-rotate { grid-area: 1 / 2; }
    #btn-left   { grid-area: 2 / 1; }
    #btn-down   { grid-area: 2 / 2; }
    #btn-right  { grid-area: 2 / 3; }

    /* â”€â”€ í„°ì¹˜ ê¸°ê¸° ë ˆì´ì•„ì›ƒ
       (hover:none) ì¡°ê±´ ì—†ì´ (pointer:coarse) ë‹¨ë… ì‚¬ìš©
       â†’ ë” ë„“ì€ ë²”ìœ„ì˜ í„°ì¹˜ ê¸°ê¸°(Z Fold í¬í•¨)ì—ì„œ ë§¤ì¹­ ë³´ì¥ â”€â”€ */
    @media (pointer: coarse) {
      .app {
        justify-content: flex-start;
      }
      .sidebar      { display: none; }
      .mobile-info  { display: flex; }
      .touch-pad    { display: grid; }
      .game-area    { justify-content: center; flex: 1; align-items: center; }
    }

    /* â”€â”€ ê²Œì„ ì˜¤ë²„ ì˜¤ë²„ë ˆì´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(7,10,16,.88);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 0.9rem;
      text-align: center;
      z-index: 200;
    }
    #overlay.show { display: flex; }
    #overlay h2 {
      font-size: 2.4rem;
      font-weight: 800;
      color: var(--danger);
      letter-spacing: -0.02em;
    }
    #overlay p { color: var(--muted); font-size: 0.95rem; }
    #overlay kbd {
      display: inline-block;
      padding: 0.2rem 0.55rem;
      background: rgba(90,140,180,.12);
      border: 1px solid rgba(90,140,180,.28);
      border-radius: 5px;
      font-size: 0.88rem;
      color: var(--accent);
    }
    #final-score { color: var(--text); font-size: 1.05rem; font-weight: 600; }
    .overlay-mobile {
      display: none;
      color: var(--muted);
      font-size: 0.88rem;
    }
    @media (pointer: coarse) {
      .overlay-mobile { display: block; }
    }

    /* â”€â”€ ì „ì²´í™”ë©´ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ (ì¢Œìƒë‹¨ ê³ ì •) â”€â”€ */
    #fs-back {
      display: none;          /* ì „ì²´í™”ë©´ ì§„ì… ì‹œ JSë¡œ í‘œì‹œ */
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 999;
      height: 44px;
      padding: 0 16px;
      background: rgba(7,10,16,.82);
      border: 1px solid rgba(0,212,255,.35);
      border-radius: 10px;
      color: var(--text);
      font-size: 0.88rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      align-items: center;
      gap: 6px;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    #fs-back:active { background: rgba(0,212,255,.15); }

    /* â”€â”€ ì „ì²´í™”ë©´ í•´ì œ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mi-fs {
      background: none;
      border: 1px solid rgba(251,113,133,.45);
      border-radius: 6px;
      color: rgba(251,113,133,.9);
      font-size: 0.85rem;
      font-weight: 700;
      width: 36px; height: 28px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      line-height: 1;
    }
  </style>
</head>
<body>

<div class="app">

  <!-- ëª¨ë°”ì¼ ìƒë‹¨ ì •ë³´ë°” -->
  <div class="mobile-info">
    <div class="mi-item">
      <span class="mi-label">Score</span>
      <span class="mi-val" id="m-score">0</span>
    </div>
    <div class="mi-item">
      <span class="mi-label">Level</span>
      <span class="mi-val" id="m-level">1</span>
    </div>
    <div class="mi-item">
      <span class="mi-label">Lines</span>
      <span class="mi-val" id="m-lines">0</span>
    </div>
    <div class="mi-item">
      <span class="mi-label">Next</span>
      <canvas id="m-next-canvas" width="44" height="34"></canvas>
    </div>
    <div class="mi-item">
      <button class="mi-mute" id="mute-btn-m" aria-label="ì†Œë¦¬ ë„ê¸°/ì¼œê¸°">ğŸ”Š</button>
    </div>
    <div class="mi-item">
      <!-- ì „ì²´í™”ë©´ ì§„ì… ì‹œì—ë§Œ í‘œì‹œ -->
      <button class="mi-fs" id="fs-btn" style="display:none" aria-label="ì „ì²´í™”ë©´ í•´ì œ">âœ•</button>
    </div>
  </div>

  <!-- ê²Œì„ ì˜ì—­ -->
  <div class="game-area">
    <canvas id="board"></canvas>

    <aside class="sidebar">
      <div class="panel">
        <div class="panel-label">Score</div>
        <div class="panel-value" id="score">0</div>
      </div>
      <div class="panel">
        <div class="panel-label">Level</div>
        <div class="panel-value" id="level">1</div>
      </div>
      <div class="panel">
        <div class="panel-label">Lines</div>
        <div class="panel-value" id="lines">0</div>
      </div>
      <div class="panel">
        <div class="panel-label">Next</div>
        <canvas id="next-canvas" width="110" height="70"></canvas>
      </div>
      <div class="panel hint">
        <b>â† â†’</b> ì´ë™<br>
        <b>â†‘</b> íšŒì „<br>
        <b>â†“</b> ë¹ ë¥¸ í•˜ê°•<br>
        <b>R</b> ì¬ì‹œì‘
      </div>
      <div class="panel">
        <button class="mute-btn" id="mute-btn" aria-label="ì†Œë¦¬ ë„ê¸°/ì¼œê¸°">ğŸ”Š BGM</button>
      </div>
    </aside>
  </div>

  <!-- ëª¨ë°”ì¼ í„°ì¹˜ ì»¨íŠ¸ë¡¤ (í•˜ë‹¨ ê³ ì •) -->
  <div class="touch-pad">
    <button class="tc-btn" id="btn-rotate">â†‘</button>
    <button class="tc-btn" id="btn-left">â†</button>
    <button class="tc-btn" id="btn-down">â†“</button>
    <button class="tc-btn" id="btn-right">â†’</button>
  </div>

</div>

<!-- ì „ì²´í™”ë©´ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
<button id="fs-back" aria-label="Playgroundë¡œ ëŒì•„ê°€ê¸°">â† Playground</button>

<!-- BGM (ê°™ì€ í´ë”ì˜ bgm.mp3) -->
<audio id="bgm" src="bgm.mp3" loop preload="auto"></audio>

<!-- ê²Œì„ ì˜¤ë²„ -->
<div id="overlay">
  <h2>Game Over</h2>
  <div id="final-score"></div>
  <p>Press <kbd>R</kbd> to restart</p>
  <p class="overlay-mobile">í™”ë©´ì„ íƒ­í•˜ì—¬ ì¬ì‹œì‘</p>
</div>

<script>
  /* â”€â”€ ìƒìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const COLS = 10, ROWS = 20;

  /* â”€â”€ 7ê°€ì§€ í…ŒíŠ¸ë¡œë¯¸ë…¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const PIECES = [
    { shape: [[1,1,1,1]],           color: '#22d3ee' }, // I
    { shape: [[1,1],[1,1]],         color: '#fbbf24' }, // O
    { shape: [[0,1,0],[1,1,1]],     color: '#a78bfa' }, // T
    { shape: [[0,1,1],[1,1,0]],     color: '#34d399' }, // S
    { shape: [[1,1,0],[0,1,1]],     color: '#fb7185' }, // Z
    { shape: [[1,0,0],[1,1,1]],     color: '#60a5fa' }, // J
    { shape: [[0,0,1],[1,1,1]],     color: '#f97316' }, // L
  ];
  const SCORE_TABLE = [0, 100, 300, 500, 800];

  /* â”€â”€ BGM ì œì–´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ë¸Œë¼ìš°ì € autoplay ì •ì±…: ì²« ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ì—ë§Œ ì¬ìƒ ê°€ëŠ¥
     ì²« í‚¤/í„°ì¹˜ ì‹œ bgm.play() ì‹œë„, ë®¤íŠ¸ ë²„íŠ¼ìœ¼ë¡œ í† ê¸€           */
  const bgm        = document.getElementById('bgm');
  let bgmStarted   = false;
  let bgmMuted     = false;

  function tryPlayBgm() {
    if (bgmStarted) return;
    bgm.volume = 0.45;
    bgm.play().then(() => { bgmStarted = true; }).catch(() => {});
  }

  function toggleMute() {
    bgmMuted  = !bgmMuted;
    bgm.muted = bgmMuted;
    const icon = bgmMuted ? 'ğŸ”‡ BGM' : 'ğŸ”Š BGM';
    const iconM = bgmMuted ? 'ğŸ”‡' : 'ğŸ”Š';
    document.getElementById('mute-btn').textContent  = icon;
    document.getElementById('mute-btn-m').textContent = iconM;
  }

  document.getElementById('mute-btn').addEventListener('click', toggleMute);
  document.getElementById('mute-btn-m').addEventListener('click', toggleMute);

  // ì²« ìƒí˜¸ì‘ìš© ì‹œ BGM ì‹œì‘
  document.addEventListener('keydown',    tryPlayBgm);
  document.addEventListener('touchstart', tryPlayBgm, { passive: true });

  /* â”€â”€ DOM ì°¸ì¡° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const boardCanvas = document.getElementById('board');
  const ctx         = boardCanvas.getContext('2d');
  const nextCanvas  = document.getElementById('next-canvas');
  const nctx        = nextCanvas.getContext('2d');
  const mNextCanvas = document.getElementById('m-next-canvas');
  const mnctx       = mNextCanvas.getContext('2d');

  /* â”€â”€ CELL í¬ê¸° ë™ì  ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ëª¨ë°”ì¼: ì •ë³´ë°”(~48px) + í„°ì¹˜íŒ¨ë“œ(~146px) + ì—¬ë°±ì„ ì œì™¸í•œ
     ê³µê°„ì— 10Ã—20 ë³´ë“œê°€ ë”± ë§ëŠ” ì…€ í¬ê¸°ë¥¼ ê³„ì‚°.
     Z Fold í¼ì¹¨/ì ‘í˜ ì‹œ resize ì´ë²¤íŠ¸ë¡œ ì¬ê³„ì‚°ë¨.           */
  let CELL = 30;

  // CSSì™€ ë™ì¼ ì¡°ê±´: (pointer: coarse) ë‹¨ë… ì‚¬ìš©
  const isTouchDevice = () => window.matchMedia('(pointer: coarse)').matches;

  function calcCell() {
    if (!isTouchDevice()) {
      // ë°ìŠ¤í¬íƒ‘ (ë§ˆìš°ìŠ¤) â†’ ê³ ì • ì…€ í¬ê¸°
      CELL = 30;
    } else {
      // í„°ì¹˜ ê¸°ê¸°: ì •ë³´ë°”(50px) + í„°ì¹˜íŒ¨ë“œ(160px) + ì—¬ë°± ì œì™¸í•œ ê³µê°„ì— í”¼íŒ…
      const INFO_H = 50;
      const PAD_H  = 160;
      const MARGIN = 16;
      const availW = window.innerWidth  - MARGIN;
      const availH = window.innerHeight - INFO_H - PAD_H - MARGIN;
      CELL = Math.max(16, Math.floor(Math.min(availW / COLS, availH / ROWS)));
    }
    boardCanvas.width  = CELL * COLS;
    boardCanvas.height = CELL * ROWS;
  }

  /* â”€â”€ ê²Œì„ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  let board, current, nextPiece;
  let score, level, lines;
  let dropTimer, dropInterval;
  let isGameOver;

  /* â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  function init() {
    board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
    score = 0; level = 1; lines = 0;
    dropTimer = 0; dropInterval = 800;
    isGameOver = false;
    document.getElementById('overlay').classList.remove('show');
    // ì¬ì‹œì‘ ì‹œ BGM ì¬ê°œ
    if (bgmStarted && !bgmMuted) bgm.play().catch(() => {});
    updateUI();
    nextPiece = randomPiece();
    spawnPiece();
  }

  function randomPiece() {
    const p = PIECES[Math.floor(Math.random() * PIECES.length)];
    return { shape: p.shape.map(r => [...r]), color: p.color };
  }

  /* â”€â”€ ìƒˆ ë¸”ë¡ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  function spawnPiece() {
    current = {
      shape: nextPiece.shape.map(r => [...r]),
      color: nextPiece.color,
      x: Math.floor((COLS - nextPiece.shape[0].length) / 2),
      y: 0,
    };
    nextPiece = randomPiece();
    drawNext();
    // ìŠ¤í° ì¦‰ì‹œ ì¶©ëŒ = ê²Œì„ ì˜¤ë²„
    if (collides(current, current.x, current.y)) {
      isGameOver = true;
      document.getElementById('final-score').textContent = `Score: ${score}`;
      document.getElementById('overlay').classList.add('show');
      bgm.pause(); // ê²Œì„ ì˜¤ë²„ ì‹œ BGM ì •ì§€
    }
  }

  /* â”€â”€ ì¶©ëŒ ê²€ì‚¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  function collides(piece, px, py) {
    for (let r = 0; r < piece.shape.length; r++)
      for (let c = 0; c < piece.shape[r].length; c++) {
        if (!piece.shape[r][c]) continue;
        const nx = px + c, ny = py + r;
        if (nx < 0 || nx >= COLS || ny >= ROWS) return true;
        if (ny >= 0 && board[ny][nx]) return true;
      }
    return false;
  }

  /* â”€â”€ ì‹œê³„ë°©í–¥ 90Â° íšŒì „ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  function rotateShape(shape) {
    const rows = shape.length, cols = shape[0].length;
    const res = Array.from({ length: cols }, () => Array(rows).fill(0));
    for (let r = 0; r < rows; r++)
      for (let c = 0; c < cols; c++)
        res[c][rows - 1 - r] = shape[r][c];
    return res;
  }

  /* â”€â”€ ë¸”ë¡ ê³ ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  function lock() {
    for (let r = 0; r < current.shape.length; r++)
      for (let c = 0; c < current.shape[r].length; c++)
        if (current.shape[r][c])
          board[current.y + r][current.x + c] = current.color;
    clearLines();
    spawnPiece();
  }

  /* â”€â”€ ê°€ë¡œ ë¼ì¸ ì œê±° + ì ìˆ˜ ê³„ì‚° â”€â”€â”€â”€â”€  */
  function clearLines() {
    let cleared = 0;
    for (let r = ROWS - 1; r >= 0; r--) {
      if (board[r].every(cell => cell !== 0)) {
        board.splice(r, 1);
        board.unshift(Array(COLS).fill(0));
        cleared++;
        r++; // ê°™ì€ ì¸ë±ìŠ¤ ì¬ê²€ì‚¬
      }
    }
    if (!cleared) return;
    lines += cleared;
    score += SCORE_TABLE[cleared] * level;
    level  = Math.floor(lines / 10) + 1;
    dropInterval = Math.max(80, 800 - (level - 1) * 72);
    updateUI();
  }

  /* â”€â”€ UI ì—…ë°ì´íŠ¸ (ë°ìŠ¤í¬íƒ‘ + ëª¨ë°”ì¼) â”€  */
  function updateUI() {
    document.getElementById('score').textContent   = score;
    document.getElementById('level').textContent   = level;
    document.getElementById('lines').textContent   = lines;
    document.getElementById('m-score').textContent = score;
    document.getElementById('m-level').textContent = level;
    document.getElementById('m-lines').textContent = lines;
  }

  /* â”€â”€ ì…€ í•˜ë‚˜ ê·¸ë¦¬ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  function drawCell(context, x, y, color) {
    const px = x * CELL, py = y * CELL;
    context.fillStyle = color;
    context.fillRect(px + 1, py + 1, CELL - 2, CELL - 2);
    // ìƒë‹¨ í•˜ì´ë¼ì´íŠ¸ (ì…€ í¬ê¸°ì— ë¹„ë¡€)
    if (CELL >= 16) {
      context.fillStyle = 'rgba(255,255,255,0.18)';
      context.fillRect(px + 2, py + 2, CELL - 4, Math.max(2, Math.floor(CELL / 6)));
    }
  }

  /* â”€â”€ ë³´ë“œ ê·¸ë¦¬ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ê·¸ë¦¬ë“œ ë¼ì¸: opacity 0.15ë¡œ ê°€ì‹œì„± ê°œì„   */
  function drawBoard() {
    ctx.clearRect(0, 0, boardCanvas.width, boardCanvas.height);
    ctx.strokeStyle = 'rgba(90,140,180,0.15)';
    ctx.lineWidth = 0.5;
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        ctx.strokeRect(c * CELL, r * CELL, CELL, CELL);
        if (board[r][c]) drawCell(ctx, c, r, board[r][c]);
      }
    }
  }

  /* â”€â”€ ê³ ìŠ¤íŠ¸ ë¸”ë¡ (ì°©ì§€ ìœ„ì¹˜ ë¯¸ë¦¬ë³´ê¸°) â”€  */
  function drawGhost() {
    let ghostY = current.y;
    while (!collides(current, current.x, ghostY + 1)) ghostY++;
    if (ghostY === current.y) return;
    ctx.globalAlpha = 0.18;
    for (let r = 0; r < current.shape.length; r++)
      for (let c = 0; c < current.shape[r].length; c++)
        if (current.shape[r][c])
          drawCell(ctx, current.x + c, ghostY + r, current.color);
    ctx.globalAlpha = 1;
  }

  /* â”€â”€ í˜„ì¬ ë¸”ë¡ ê·¸ë¦¬ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  function drawCurrent() {
    for (let r = 0; r < current.shape.length; r++)
      for (let c = 0; c < current.shape[r].length; c++)
        if (current.shape[r][c])
          drawCell(ctx, current.x + c, current.y + r, current.color);
  }

  /* â”€â”€ ë‹¤ìŒ ë¸”ë¡ ë¯¸ë¦¬ë³´ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  function drawNextOn(context, cw, ch) {
    context.clearRect(0, 0, cw, ch);
    const nc  = Math.min(
      Math.floor(cw / (nextPiece.shape[0].length + 0.5)),
      Math.floor(ch / (nextPiece.shape.length    + 0.5))
    );
    const offX = Math.floor((cw - nextPiece.shape[0].length * nc) / 2);
    const offY = Math.floor((ch - nextPiece.shape.length    * nc) / 2);
    for (let r = 0; r < nextPiece.shape.length; r++)
      for (let c = 0; c < nextPiece.shape[r].length; c++)
        if (nextPiece.shape[r][c]) {
          context.fillStyle = nextPiece.color;
          context.fillRect(offX + c * nc + 1, offY + r * nc + 1, nc - 2, nc - 2);
          if (nc >= 10) {
            context.fillStyle = 'rgba(255,255,255,0.18)';
            context.fillRect(offX + c * nc + 2, offY + r * nc + 2, nc - 4, Math.max(2, Math.floor(nc / 5)));
          }
        }
  }
  function drawNext() {
    drawNextOn(nctx,  nextCanvas.width,  nextCanvas.height);
    drawNextOn(mnctx, mNextCanvas.width, mNextCanvas.height);
  }

  /* â”€â”€ ë Œë” (ì…ë ¥ í›„ ì¦‰ì‹œ ì¬ê·¸ë¦¬ê¸°) â”€â”€â”€  */
  function render() {
    if (!isGameOver && current) { drawBoard(); drawGhost(); drawCurrent(); }
  }

  /* â”€â”€ ì…ë ¥ ì²˜ë¦¬ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  function moveLeft() {
    if (isGameOver) return;
    if (!collides(current, current.x - 1, current.y)) current.x--;
    render();
  }
  function moveRight() {
    if (isGameOver) return;
    if (!collides(current, current.x + 1, current.y)) current.x++;
    render();
  }
  function moveDown() {
    if (isGameOver) return;
    if (!collides(current, current.x, current.y + 1)) {
      current.y++;
      score++;
      updateUI();
    } else {
      lock();
    }
    dropTimer = 0;
    render();
  }
  function doRotate() {
    if (isGameOver) return;
    const rotated = rotateShape(current.shape);
    const kicks   = [0, -1, 1, -2, 2];
    for (const kick of kicks) {
      if (!collides({ shape: rotated }, current.x + kick, current.y)) {
        current.shape = rotated;
        current.x    += kick;
        break;
      }
    }
    render();
  }

  /* â”€â”€ í‚¤ë³´ë“œ ì…ë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  document.addEventListener('keydown', e => {
    if (e.key === 'r' || e.key === 'R') { init(); return; }
    if (isGameOver) return;
    switch (e.key) {
      case 'ArrowLeft':  e.preventDefault(); moveLeft();  break;
      case 'ArrowRight': e.preventDefault(); moveRight(); break;
      case 'ArrowDown':  e.preventDefault(); moveDown();  break;
      case 'ArrowUp':    e.preventDefault(); doRotate();  break;
    }
  });

  /* â”€â”€ í„°ì¹˜ ë²„íŠ¼ ë°”ì¸ë”© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     - ì´ë™ ë²„íŠ¼: ë¡±í”„ë ˆìŠ¤ ì‹œ 130ms ê°„ê²© ì—°ì† ì…ë ¥
     - íšŒì „ ë²„íŠ¼: íƒ­ 1íšŒë§Œ (ì—°ì† íšŒì „ ë°©ì§€)            */
  function bindRepeat(id, action) {
    const btn = document.getElementById(id);
    if (!btn) return;
    let timer = null;
    const press = e => {
      e.preventDefault();
      action();
      timer = setInterval(action, 130);
    };
    const release = () => { if (timer) { clearInterval(timer); timer = null; } };
    btn.addEventListener('touchstart',  press,   { passive: false });
    btn.addEventListener('touchend',    release);
    btn.addEventListener('touchcancel', release);
    btn.addEventListener('mousedown',   press);
    btn.addEventListener('mouseup',     release);
    btn.addEventListener('mouseleave',  release);
  }

  function bindTap(id, action) {
    const btn = document.getElementById(id);
    if (!btn) return;
    btn.addEventListener('touchstart', e => { e.preventDefault(); action(); }, { passive: false });
    btn.addEventListener('mousedown',  () => action());
  }

  /* â”€â”€ ì „ì²´í™”ë©´ ì œì–´ (ëª¨ë°”ì¼ ì „ìš©) â”€â”€â”€â”€â”€â”€â”€â”€
     - ì²« í„°ì¹˜ ì‹œ requestFullscreen() ìë™ ì§„ì…
     - portrait ë°©í–¥ ê³ ì • (ì§€ì› ê¸°ê¸°ë§Œ)
     - âœ• ë²„íŠ¼ìœ¼ë¡œ í•´ì œ, fullscreenchangeë¡œ ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™”  */
  const fsBtn = document.getElementById('fs-btn');

  function enterFullscreen() {
    const el  = document.documentElement;
    const req = el.requestFullscreen || el.webkitRequestFullscreen;
    if (!req) return;
    req.call(el)
      .then(() => {
        if (screen.orientation && screen.orientation.lock) {
          screen.orientation.lock('portrait').catch(() => {});
        }
      })
      .catch(() => {});
  }

  function exitFullscreen() {
    const exit = document.exitFullscreen || document.webkitExitFullscreen;
    if (exit) exit.call(document);
  }

  const fsBack = document.getElementById('fs-back');

  // ì „ì²´í™”ë©´ ìƒíƒœ ë³€ê²½ ì‹œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ë™ê¸°í™”
  function onFsChange() {
    const inFs = !!(document.fullscreenElement || document.webkitFullscreenElement);
    fsBtn.style.display    = inFs ? '' : 'none';
    fsBack.style.display   = inFs ? 'flex' : 'none';
  }
  document.addEventListener('fullscreenchange',       onFsChange);
  document.addEventListener('webkitfullscreenchange', onFsChange);
  fsBtn.addEventListener('click', exitFullscreen);

  // ë’¤ë¡œê°€ê¸°: ì „ì²´í™”ë©´ í•´ì œ í›„ /playground ì´ë™
  fsBack.addEventListener('click', () => {
    exitFullscreen();
    window.location.href = '/playground';
  });

  // ì²« í„°ì¹˜ ì‹œ ìë™ ì „ì²´í™”ë©´ ì§„ì… (í„°ì¹˜ ê¸°ê¸°ë§Œ)
  document.addEventListener('touchstart', () => {
    if (isTouchDevice()) enterFullscreen();
  }, { once: true, passive: true });

  /* â”€â”€ ëª¨ë°”ì¼: ê²Œì„ ì˜¤ë²„ í™”ë©´ íƒ­ ì¬ì‹œì‘ â”€  */
  document.getElementById('overlay').addEventListener('click', () => init());

  /* â”€â”€ ë©”ì¸ ê²Œì„ ë£¨í”„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  let lastTime = 0;
  function loop(ts) {
    const dt = ts - lastTime;
    lastTime = ts;
    if (!isGameOver) {
      dropTimer += dt;
      if (dropTimer >= dropInterval) {
        dropTimer = 0;
        if (!collides(current, current.x, current.y + 1)) {
          current.y++;
        } else {
          lock();
        }
      }
      if (!isGameOver) { drawBoard(); drawGhost(); drawCurrent(); }
    }
    requestAnimationFrame(loop);
  }

  /* â”€â”€ í™”ë©´ í¬ê¸° ë³€ê²½ (Z Fold í¼ì¹¨ ë“±) â”€
     ë·°í¬íŠ¸ ë³€ê²½ ì‹œ CELL ì¬ê³„ì‚° í›„ ì¦‰ì‹œ ë°˜ì˜  */
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    // Z Fold ê°™ì€ ê¸°ê¸°ëŠ” resizeê°€ ì—°ì† ë°œìƒí•  ìˆ˜ ìˆì–´ ë””ë°”ìš´ìŠ¤ ì²˜ë¦¬
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      calcCell();
      render();
    }, 80);
  });

  /* â”€â”€ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
  calcCell();
  bindRepeat('btn-left',  moveLeft);
  bindRepeat('btn-right', moveRight);
  bindRepeat('btn-down',  moveDown);
  bindTap(   'btn-rotate', doRotate);
  init();
  requestAnimationFrame(loop);
</script>
</body>
</html>
